<html>
<head>
  <style>
    body {
      background-color: rgb(0, 0, 0);
    }

    h1 {
      color: white;
    }
  </style>
  <script type="module">
    import { Octokit } from "https://cdn.skypack.dev/@octokit/core";

    var oldusernames;
    var oldmessages;
    
    // getting the current data
    (async () => {
      const data1 = await fetch('./data.json').then(r => r.json());
      oldusernames = data1.data[0];
      oldmessages = data1.data[1];
      
      oldusernames = JSON.stringify(oldusernames);
      oldmessages = JSON.stringify(oldmessages);
      
      oldusernames = oldusernames.replace('{"name":"','');
      oldusernames = oldusernames.replace('"}','');
      oldmessages = oldmessages.replace('{"message":"','');
      oldmessages = oldmessages.replace('"}','');

      // ?name=skparab1&message=t
      var loc = window.location.href; //get the url
      var data;

      //                  https://skparab1.github.io/server/sendmsg.html?
      data = loc.replace('https://skparab1.github.io/server/sendmsg.html?',''); //extract the metadata
      data = data.replace('file:///Users/homemac/Desktop/Programming/Other%20programs/server/ui/sender.html?',''); // this is for test
      data = data.split('&');
      var username = data[0].replace('name=','');
      var message = data[1].replace('message=','');
      var rname = data[2].replace('rname=','');

            
      var sendusernames = oldusernames + '&nextentry&' + username;
      var sendmessages = oldmessages + '&nextentry&' + message;

      var today = new Date();
      var date = today.getFullYear()+'/'+(today.getMonth()+1)+'/'+today.getDate();
      var hour = parseInt(today.getHours());
      var suffix;
      if (hour > 12){
        hour = hour - 12;
        suffix = 'PM';
      } else if (hour == 12){
        suffix = 'PM';
      } else {
        suffix = 'AM';
      }

      hour = String(hour);
      if (hour.length == 1){
        hour = '0'+hour;
      }

      var minute = String(today.getMinutes());
      if (minute.length == 1){
        minute = '0'+minute;
      }

      var second = String(today.getSeconds());
      if (second.length == 1){
        second = '0'+second;
      }

      var time = hour + ":" + minute + ":" + second + ' '+suffix;
      var datetime = date+' at '+time;

      var sendusernames = sendusernames + '&rname='+rname;

      sendmessages = sendmessages + '&currenttime='+datetime;
      
      (async () => {
        const octokit = new Octokit({ auth: "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" }); // you shouldnt hardcode this
        octokit.request('GET /repos/:owner/:repo', {
          owner: "skparab1",
          repo: "server"
        }).then(response => console.log(response.data))
        async function start() {
          return await octokit.request('POST /repos/skparab1/server/issues', {
              owner: 'skparab1',
              repo: 'server',
              title: sendusernames,
              body: sendmessages,
              tags: 'serverdata'
            })
        };
        
        start();

        localStorage.setItem('sent','true');
      })();
      //setTimeout(function(){window.open('https://skparab1.github.io/server/frontend.html',"_self");},1000);
    })();

    //var redirect = setTimeout(window.open('https://skparab1.github.io/ui',"_self")[6000]);
  </script>    
</head>

<body>

  <h1>Sending ur message...</h1>
  <img src="loading.gif" alt="loading" style="width: 20%; text-align: center;">
  <h1>If you are not redirected within a few seconds click <a href="https://skparab1.github.io/server/frontend.html">here</a></h1>

</body>
</html>
